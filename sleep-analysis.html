<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleep Analysis - Sleep & Productivity Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a2b3c;
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 340px;
            background: #f5f5f5;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 40px;
            padding: 0 10px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #5b7fd4;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .logo-text {
            font-size: 16px;
            font-weight: 600;
            color: #1a2b3c;
        }

        .nav-menu {
            list-style: none;
            flex: 1;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 10px;
            text-decoration: none;
            color: #666;
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-link:hover {
            background: #e8eef7;
            color: #5b7fd4;
        }

        .nav-link.active {
            background: #d4e3f7;
            color: #5b7fd4;
        }

        .nav-icon {
            font-size: 20px;
            width: 24px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-top: 1px solid #ddd;
            margin-top: auto;
            cursor: pointer;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #5b7fd4;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: #1a2b3c;
            font-size: 14px;
        }

        .user-role {
            font-size: 12px;
            color: #999;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .page-header {
            margin-bottom: 20px;
        }

        .page-title {
            font-size: 36px;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 14px;
            color: #94a3b8;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
        }

        .stat-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #1a2b3c;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            color: #1a2b3c;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            outline: none;
        }

        /* Sleep Pattern Chart */
        .chart-legend {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .line-chart-container {
            height: 250px;
            position: relative;
            border-bottom: 2px solid #e0e0e0;
            border-left: 2px solid #e0e0e0;
        }

        .chart-grid {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .grid-line {
            width: 100%;
            height: 1px;
            background: #f0f0f0;
        }

        .chart-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            color: #999;
        }

        /* Calendar Heatmap */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .calendar-month {
            font-weight: 600;
            color: #1a2b3c;
        }

        .calendar-legend {
            display: flex;
            gap: 12px;
            font-size: 11px;
        }

        .legend-badge {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 16px;
        }

        .day-label {
            text-align: center;
            font-size: 11px;
            color: #999;
            font-weight: 600;
            padding: 8px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-day:hover {
            transform: scale(1.05);
        }

        .calendar-day.empty {
            background: transparent;
        }

        .calendar-day.excellent {
            background: #4ade80;
            color: white;
        }

        .calendar-day.good {
            background: #60a5fa;
            color: white;
        }

        .calendar-day.fair {
            background: #a78bfa;
            color: white;
        }

        .calendar-day.poor {
            background: #94a3b8;
            color: white;
        }

        .calendar-day.future {
            background: #f1f5f9;
            color: #cbd5e1;
        }

        /* Productivity Meters */
        .meter-item {
            margin-bottom: 20px;
        }

        .meter-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .meter-label {
            font-size: 14px;
            color: #666;
        }

        .meter-value {
            font-size: 14px;
            font-weight: 700;
            color: #1a2b3c;
        }

        .meter-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .meter-fill {
            height: 100%;
            background: #5b7fd4;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Quick Insights */
        .insight-item {
            display: flex;
            gap: 12px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .insight-icon {
            width: 36px;
            height: 36px;
            background: #d4e3f7;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .insight-content {
            flex: 1;
        }

        .insight-title {
            font-size: 14px;
            font-weight: 600;
            color: #1a2b3c;
            margin-bottom: 4px;
        }

        .insight-text {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        @media (max-width: 1200px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
            }

            .main-content {
                padding: 20px;
            }

            .stats-row {
                grid-template-columns: 1fr;
            }

            .filter-select {
    padding: 8px 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    background: white;
    cursor: pointer;
    outline: none;
    transition: all 0.3s;
}

.filter-select:focus {
    border-color: #5b7fd4;
}

.filter-select:hover {
    border-color: #5b7fd4;
}
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <div class="logo-icon">🌙</div>
            <div class="logo-text">Sleep & Productivity Tracker</div>
        </div>

        <ul class="nav-menu">
            <li class="nav-item">
                <a class="nav-link" onclick="window.location.href='dashboard.html'">
                    <span class="nav-icon">📊</span>
                    Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active">
                    <span class="nav-icon">🌙</span>
                    Sleep Analysis
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="window.location.href='recommendations.html'">
                    <span class="nav-icon">💡</span>
                    Recommendations
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="window.location.href='settings.html'">
                    <span class="nav-icon">⚙️</span>
                    Settings
                </a>
            </li>
        </ul>

        <div class="user-profile" onclick="window.location.href='profile.html'">
            <div class="user-avatar">👤</div>
            <div class="user-info">
                <div class="user-name" id="profileName">Username</div>
                <div class="user-role">Profile</div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="page-header">
            <h1 class="page-title">Sleep Analysis</h1>
            <p class="page-subtitle">Track your sleep and productivity metrics over time</p>
        </div>

        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-label">Average Sleep</div>
                <div class="stat-value" id="avgSleep">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Best Sleep Day</div>
                <div class="stat-value" id="bestDay">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Sleep Quality</div>
                <div class="stat-value" id="sleepQuality">--/100</div>
            </div>
        </div>

        <div class="content-grid">
            <div>
                            <!-- Sleep Pattern Chart -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h2 class="card-title">Sleep Pattern</h2>
                    <select class="filter-select" id="patternFilter" onchange="updateChart()">
                        <option value="all">All</option>
                        <option value="excellent">Excellent</option>
                        <option value="good">Good</option>
                        <option value="fair">Fair</option>
                        <option value="poor">Poor</option>
                    </select>
                </div>
                
                <div class="chart-legend">
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #ef4444;"></span>
                        <span>Energy</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #3b82f6;"></span>
                        <span>Focus</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #8b5cf6;"></span>
                        <span>Productivity</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #10b981;"></span>
                        <span>Task Performance</span>
                    </div>
                </div>

                <div class="line-chart-container" id="lineChart">
                    <div class="chart-grid">
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                    </div>
                    <canvas id="patternCanvas"></canvas>
                </div>
                <div class="chart-labels" id="chartLabels">
                    <span>Mon</span>
                    <span>Tue</span>
                    <span>Wed</span>
                    <span>Thu</span>
                    <span>Fri</span>
                    <span>Sat</span>
                    <span>Sun</span>
                </div>
            </div>

                <!-- Sleep Consistency Calendar -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Sleep Consistency</h2>
                        <div class="calendar-legend">
                            <div class="legend-badge">
                                <span class="legend-color" style="background: #4ade80;"></span>
                                <span>Excellent</span>
                            </div>
                            <div class="legend-badge">
                                <span class="legend-color" style="background: #60a5fa;"></span>
                                <span>Good</span>
                            </div>
                            <div class="legend-badge">
                                <span class="legend-color" style="background: #94a3b8;"></span>
                                <span>Inconsistent</span>
                            </div>
                        </div>
                    </div>

                    <div class="calendar-header">
                        <div class="calendar-month" id="calendarMonth">July 2025</div>
                    </div>

                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>

            <div>
                <!-- Productivity Meters -->
                <div class="card" style="margin-bottom: 20px;">
                    <h2 class="card-title">Productivity Meters</h2>
                    
                    <div class="meter-item">
                        <div class="meter-header">
                            <span class="meter-label">Energy</span>
                            <span class="meter-value" id="energyPercent">--</span>
                        </div>
                        <div class="meter-bar">
                            <div class="meter-fill" id="energyBar" style="width: 0%;"></div>
                        </div>
                    </div>

                    <div class="meter-item">
                        <div class="meter-header">
                            <span class="meter-label">Focus</span>
                            <span class="meter-value" id="focusPercent">--</span>
                        </div>
                        <div class="meter-bar">
                            <div class="meter-fill" id="focusBar" style="width: 0%; background: #8b5cf6;"></div>
                        </div>
                    </div>

                    <div class="meter-item">
                        <div class="meter-header">
                            <span class="meter-label">Task Performance</span>
                            <span class="meter-value" id="taskPercent">--</span>
                        </div>
                        <div class="meter-bar">
                            <div class="meter-fill" id="taskBar" style="width: 0%; background: #10b981;"></div>
                        </div>
                    </div>
                </div>

                <!-- Quick Insights -->
                <div class="card">
                    <h2 class="card-title">Quick Insights</h2>
                    
                    <div id="insightsContainer">
                        <div class="insight-item">
                            <div class="insight-icon">💡</div>
                            <div class="insight-content">
                                <div class="insight-title">Start Tracking</div>
                                <div class="insight-text">Log your sleep data to see personalized insights here.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Initialize app
    function initializeApp() {
        if (!localStorage.getItem('sleepTrackerState')) {
            const initialState = {
                energy: 70,
                focus: 60,
                sleepDebt: 0,
                history: []
            };
            localStorage.setItem('sleepTrackerState', JSON.stringify(initialState));
        }
        
        if (!localStorage.getItem('sleepTrackerProfile')) {
            const initialProfile = {
                name: 'Username',
                dateOfBirth: '2002-01-21',
                address: '123 Mabini Street Barangay Malinís, Quezon City Metro Manila, Philippines 1103',
                sleepGoal: 8,
                memberSince: new Date().toISOString()
            };
            localStorage.setItem('sleepTrackerProfile', JSON.stringify(initialProfile));
        }
        
       
        const profile = JSON.parse(localStorage.getItem('sleepTrackerProfile'));
        document.getElementById('profileName').textContent = profile.name || 'Username';
    }

    function loadState() {
        const saved = localStorage.getItem('sleepTrackerState');
        if (saved) {
            return JSON.parse(saved);
        }
        return { energy: 70, focus: 60, sleepDebt: 0, history: [] };
    }

    // Filter functions
    function getPerformanceCategory(performance) {
        if (performance === 'Excellent') return 'excellent';
        if (performance === 'Good') return 'good';
        if (performance === 'Fair') return 'fair';
        return 'poor';
    }

    function filterDataByPerformance(data, filter) {
        if (filter === 'all') return data;
        
        return data.filter(entry => {
            const category = getPerformanceCategory(entry.performance);
            return category === filter;
        });
    }

    function updateChart() {
        const filter = document.getElementById('patternFilter').value;
        drawLineChart(filter);
        updateStats();
    }

    // Chart drawing functions - UPDATED
    function drawLineChart(filter = 'all') {
        const canvas = document.getElementById('patternCanvas');
        if (!canvas) {
            console.log('Canvas element not found');
            return;
        }
        
        const ctx = canvas.getContext('2d');
        const state = loadState();
        
        // Set canvas size properly
        const container = canvas.parentElement;
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        if (state.history.length === 0) {
            drawNoDataMessage(ctx, canvas, 'Log sleep data to see patterns');
            updateChartLabels([]);
            return;
        }
        
        let data = state.history.slice().reverse().slice(-7);
        
        // Apply filter
        if (filter !== 'all') {
            data = filterDataByPerformance(data, filter);
        }
        
        if (data.length === 0) {
            drawNoDataMessage(ctx, canvas, `No ${filter} performance data available`);
            updateChartLabels([]);
            return;
        }
        
        // Improved padding for better spacing
        const padding = { top: 40, right: 40, bottom: 40, left: 60 };
        const chartWidth = canvas.width - padding.left - padding.right;
        const chartHeight = canvas.height - padding.top - padding.bottom;
        
        // Draw background
        drawChartBackground(ctx, canvas, padding);
        
        // Draw grid and labels
        drawChartGrid(ctx, canvas, padding, chartWidth, chartHeight);
        
        // Define metrics with professional colors
        const metrics = [
            { 
                key: 'energy', 
                color: '#ef4444',
                label: 'Energy'
            },
            { 
                key: 'focus', 
                color: '#3b82f6',
                label: 'Focus'
            },
            { 
                key: 'productivity', 
                color: '#8b5cf6',
                label: 'Productivity'
            },
            {
                key: 'task',
                color: '#10b981',
                label: 'Task Performance'
            }
        ];
        
        // Draw lines and points with better spacing
        metrics.forEach(metric => {
            drawMetricLine(ctx, data, metric, padding, chartWidth, chartHeight);
        });
        
        // Update X-axis labels based on filtered data
        updateChartLabels(data);
    }

    function drawNoDataMessage(ctx, canvas, message) {
        ctx.fillStyle = '#94a3b8';
        ctx.font = '14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(message, canvas.width / 2, canvas.height / 2);
    }

    function drawChartBackground(ctx, canvas, padding) {
        // Draw white background
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function drawChartGrid(ctx, canvas, padding, chartWidth, chartHeight) {
        ctx.strokeStyle = '#f8fafc';
        ctx.lineWidth = 1;
        ctx.fillStyle = '#64748b';
        ctx.font = '11px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        
        // Draw horizontal grid lines and Y-axis labels
        for (let i = 0; i <= 4; i++) {
            const y = padding.top + (chartHeight / 4) * i;
            const value = 100 - i * 25;
            
            // Grid line
            ctx.beginPath();
            ctx.moveTo(padding.left, y);
            ctx.lineTo(canvas.width - padding.right, y);
            ctx.stroke();
            
            // Y-axis label
            ctx.textAlign = 'right';
            ctx.fillText(value + '%', padding.left - 8, y + 3);
        }
    }

    // UPDATED: Improved metric line drawing with better point distribution
    function drawMetricLine(ctx, data, metric, padding, chartWidth, chartHeight) {
        if (data.length === 0) return;
        
        ctx.beginPath();
        ctx.strokeStyle = metric.color;
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        // Calculate x spacing based on number of data points
        const xSpacing = data.length > 1 ? chartWidth / (data.length - 1) : chartWidth;
        
        data.forEach((entry, i) => {
            const value = metric.key === 'productivity' 
                ? (entry.energy + entry.focus) / 2 
                : metric.key === 'task'
                ? getTaskPerformanceValue(entry.energy)
                : entry[metric.key];
            
            const x = padding.left + (xSpacing * i);
            const y = padding.top + chartHeight - (value / 100) * chartHeight;
            
            if (i === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        });
        
        ctx.stroke();
        
        // Draw data points with better visibility
        data.forEach((entry, i) => {
            const value = metric.key === 'productivity' 
                ? (entry.energy + entry.focus) / 2 
                : metric.key === 'task'
                ? getTaskPerformanceValue(entry.energy)
                : entry[metric.key];
            
            const x = padding.left + (data.length > 1 ? (chartWidth / (data.length - 1)) * i : chartWidth / 2);
            const y = padding.top + chartHeight - (value / 100) * chartHeight;
            
            // Outer circle
            ctx.beginPath();
            ctx.fillStyle = metric.color;
            ctx.arc(x, y, 6, 0, Math.PI * 2);
            ctx.fill();
            
            // Inner white circle
            ctx.beginPath();
            ctx.fillStyle = 'white';
            ctx.arc(x, y, 3, 0, Math.PI * 2);
            ctx.fill();
        });
    }

    function getTaskPerformanceValue(energy) {
        if (energy >= 80) return 90;
        if (energy >= 60) return 70;
        return 50;
    }

    function getPerformanceColor(performance) {
        switch(performance) {
            case 'Excellent': return '#10b981';
            case 'Good': return '#3b82f6';
            case 'Fair': return '#f59e0b';
            case 'Poor': return '#ef4444';
            default: return '#94a3b8';
        }
    }

    function updateChartLabels(data) {
        const labelsContainer = document.getElementById('chartLabels');
        
        if (!data || data.length === 0) {
            // Show default day labels
            labelsContainer.innerHTML = `
                <span>Mon</span>
                <span>Tue</span>
                <span>Wed</span>
                <span>Thu</span>
                <span>Fri</span>
                <span>Sat</span>
                <span>Sun</span>
            `;
            return;
        }
        
        // Create labels based on actual data days
        let labelsHtml = '';
        data.forEach(entry => {
            // Use short day names from the entry
            const shortDay = entry.day.replace('Day ', 'D');
            labelsHtml += `<span>${shortDay}</span>`;
        });
        
        labelsContainer.innerHTML = labelsHtml;
    }

    // Stats and insights functions
    function updateStats() {
        const state = loadState();
        const filter = document.getElementById('patternFilter').value;
        
        let data = state.history;
        
        // Apply filter to stats as well
        if (filter !== 'all') {
            data = filterDataByPerformance(data, filter);
        }
        
        if (data.length === 0) {
            document.getElementById('avgSleep').textContent = '--';
            document.getElementById('bestDay').textContent = '--';
            document.getElementById('sleepQuality').textContent = '--/100';
            document.getElementById('energyPercent').textContent = '--';
            document.getElementById('focusPercent').textContent = '--';
            document.getElementById('taskPercent').textContent = '--';
            document.getElementById('energyBar').style.width = '0%';
            document.getElementById('focusBar').style.width = '0%';
            document.getElementById('taskBar').style.width = '0%';
            updateInsights([], filter);
            return;
        }

        // Calculate stats based on filtered data
        const avgSleep = (data.reduce((sum, h) => sum + h.hours, 0) / data.length).toFixed(1);
        const bestEntry = data.reduce((best, curr) => curr.hours > best.hours ? curr : best, data[0]);
        const bestDay = bestEntry.day;
        const quality = Math.round((avgSleep / 8) * 100);

        document.getElementById('avgSleep').textContent = avgSleep + 'h';
        document.getElementById('bestDay').textContent = bestDay;
        document.getElementById('sleepQuality').textContent = quality + '/100';

        // Update meters
        const avgEnergy = Math.round(data.reduce((sum, h) => sum + h.energy, 0) / data.length);
        const avgFocus = Math.round(data.reduce((sum, h) => sum + h.focus, 0) / data.length);
        const avgTask = Math.round((avgEnergy + avgFocus) / 2);

        document.getElementById('energyPercent').textContent = avgEnergy + '%';
        document.getElementById('energyBar').style.width = avgEnergy + '%';
        
        document.getElementById('focusPercent').textContent = avgFocus + '%';
        document.getElementById('focusBar').style.width = avgFocus + '%';
        
        document.getElementById('taskPercent').textContent = avgTask + '%';
        document.getElementById('taskBar').style.width = avgTask + '%';

        // Update insights
        updateInsights(data, filter);
    }

    function updateInsights(data, filter) {
        const container = document.getElementById('insightsContainer');
        let html = '';

        if (data.length === 0) {
            html = `
                <div class="insight-item">
                    <div class="insight-icon">💡</div>
                    <div class="insight-content">
                        <div class="insight-title">No ${filter !== 'all' ? filter : ''} Data</div>
                        <div class="insight-text">No sleep data matches the current filter. Try logging more sleep entries.</div>
                    </div>
                </div>
            `;
        } else {
            const avgSleep = data.reduce((sum, h) => sum + h.hours, 0) / data.length;
            const bestEntry = data.reduce((best, curr) => curr.productivity > best.productivity ? curr : best);

            if (avgSleep >= 7.5) {
                html += `
                    <div class="insight-item">
                        <div class="insight-icon">⚡</div>
                        <div class="insight-content">
                            <div class="insight-title">Optimal Sleep Range</div>
                            <div class="insight-text">Your average sleep of ${avgSleep.toFixed(1)} hours is in the optimal range for productivity.</div>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="insight-item">
                        <div class="insight-icon">💡</div>
                        <div class="insight-content">
                            <div class="insight-title">Sleep Improvement</div>
                            <div class="insight-text">Aim for 7.5-8 hours of sleep to reach optimal productivity levels.</div>
                        </div>
                    </div>
                `;
            }

            html += `
                <div class="insight-item">
                    <div class="insight-icon">🎯</div>
                    <div class="insight-content">
                        <div class="insight-title">Peak Performance</div>
                        <div class="insight-text">Your best day was ${bestEntry.day} with ${bestEntry.hours} hours of sleep.</div>
                    </div>
                </div>
            `;
        }

        container.innerHTML = html;
    }

    // Calendar function
    function generateCalendar() {
        const grid = document.getElementById('calendarGrid');
        const state = loadState();
        
        // Clear existing calendar
        grid.innerHTML = '';
        
        // Day labels
        const days = ['S', 'M', 'T', 'W', 'TH', 'F', 'S'];
        days.forEach(day => {
            const label = document.createElement('div');
            label.className = 'day-label';
            label.textContent = day;
            grid.appendChild(label);
        });

        // Generate days for current month
        const today = new Date();
        const currentDay = today.getDate();
        const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
        const firstDayOfWeek = new Date(today.getFullYear(), today.getMonth(), 1).getDay();

        // Empty cells before month starts
        for (let i = 0; i < firstDayOfWeek; i++) {
            const empty = document.createElement('div');
            empty.className = 'calendar-day empty';
            grid.appendChild(empty);
        }

        // Actual days
        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';
            dayCell.textContent = day;

            // Find if we have data for this day
            const dayData = state.history.find(h => {
                const entryDate = new Date(h.date);
                return entryDate.getDate() === day && 
                       entryDate.getMonth() === today.getMonth() && 
                       entryDate.getFullYear() === today.getFullYear();
            });

            if (day > currentDay) {
                dayCell.classList.add('future');
            } else if (dayData) {
                if (dayData.hours >= 8) {
                    dayCell.classList.add('excellent');
                } else if (dayData.hours >= 7) {
                    dayCell.classList.add('good');
                } else if (dayData.hours >= 6) {
                    dayCell.classList.add('fair');
                } else {
                    dayCell.classList.add('poor');
                }
            } else {
                dayCell.classList.add('poor');
            }

            grid.appendChild(dayCell);
        }
        
        // Update calendar month display
        const monthNames = ["January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];
        document.getElementById('calendarMonth').textContent = 
            `${monthNames[today.getMonth()]} ${today.getFullYear()}`;
    }

    // Main update function
    function updateDisplay() {
        updateStats();
        drawLineChart();
        generateCalendar();
    }

    // Initialize the app - UPDATED with better timing
    document.addEventListener('DOMContentLoaded', function() {
        initializeApp();
        
        // Small delay to ensure DOM is fully rendered before drawing chart
        setTimeout(() => {
            updateDisplay();
        }, 100);
        
        // Add event listener for filter changes
        document.getElementById('patternFilter').addEventListener('change', updateChart);
        
        // Redraw chart on window resize with debounce
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                drawLineChart(document.getElementById('patternFilter').value);
            }, 250);
        });
    });
</script>
</body>
</html>
